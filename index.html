<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mental Health Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Set theme on initial load to prevent flash of unstyled content (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .journal-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out, transform 0.2s ease-in-out;
        }
        .journal-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .dark .journal-card:hover {
             box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -2px rgb(0 0 0 / 0.2);
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .topic-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }
        .mood-selector button {
            transition: all 0.2s ease-in-out;
        }
        .mood-selector button.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px var(--mood-color);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        .calendar-day.empty {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300 transition-colors duration-300">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-700 dark:text-gray-100">Smart Mental Health Journal</h1>
            <p class="text-lg text-gray-500 dark:text-gray-400 mt-2">Reflect on your day, discover your patterns.</p>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:ring-offset-gray-900" title="Toggle dark mode">
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1z"></path></svg>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Entry & Dashboard -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Entry Section -->
                <div class="journal-card bg-white dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">New Entry</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">How are you feeling right now?</label>
                        <div id="mood-selector" class="mood-selector flex items-center justify-around p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <button data-mood="Happy" title="Happy" style="--mood-color: #34D399;" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">üòä</button>
                            <button data-mood="Content" title="Content" style="--mood-color: #60A5FA;" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">üôÇ</button>
                            <button data-mood="Neutral" title="Neutral" style="--mood-color: #9CA3AF;" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">üòê</button>
                            <button data-mood="Sad" title="Sad" style="--mood-color: #F87171;" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">üò¢</button>
                            <button data-mood="Anxious" title="Anxious" style="--mood-color: #FBBF24;" class="text-3xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">üòü</button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <textarea id="journal-entry" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:placeholder-gray-400" placeholder="Start writing here..."></textarea>
                        <button id="prompt-generator-btn" class="absolute bottom-3 right-3 text-sm text-blue-500 hover:text-blue-600 dark:hover:text-blue-400 font-medium">Get a Prompt</button>
                    </div>
                    <button id="save-entry-btn" class="mt-4 w-full bg-blue-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition flex items-center justify-center">
                        <span id="button-text">Save Entry</span>
                        <div id="loader" class="loader w-5 h-5 rounded-full border-4 border-t-4 border-gray-200 ml-2 hidden"></div>
                    </button>
                    <div id="error-message" class="text-red-500 mt-2 text-sm"></div>

                    <div id="recommendation-box" class="mt-4 p-4 bg-blue-50 dark:bg-gray-700 border-l-4 border-blue-400 rounded-r-lg hidden">
                        <p class="text-sm font-semibold text-blue-800 dark:text-blue-200">A friendly suggestion:</p>
                        <p id="recommendation-text" class="text-sm text-blue-700 dark:text-blue-300 mt-1"></p>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div class="journal-card bg-white dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Sentiment Trend</h2>
                    <div id="dashboard-content">
                        <p id="dashboard-placeholder" class="text-gray-500 dark:text-gray-400">Your sentiment trends will appear here once you save an entry.</p>
                        <canvas id="sentiment-chart" class="hidden"></canvas>
                    </div>
                </div>
            </div>

             <!-- Right Column: Calendar, Streaks, Word Cloud -->
            <div class="lg:col-span-1 space-y-8">
                <div class="journal-card bg-white dark:bg-gray-800 p-6 rounded-lg text-center">
                    <h2 class="text-xl font-semibold mb-2 text-gray-700 dark:text-gray-200">Writing Streak</h2>
                    <p class="text-5xl font-bold text-amber-500">
                        <span id="streak-count">0</span> üî•
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">days in a row</p>
                </div>

                <div class="journal-card bg-white dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Mood Calendar</h2>
                    <div id="calendar-header" class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button>
                        <h3 id="current-month-year" class="font-semibold"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs text-gray-500 dark:text-gray-400 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>

                <div class="journal-card bg-white dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Topic Cloud</h2>
                    <div id="word-cloud-container" class="w-full h-64 flex items-center justify-center">
                        <canvas id="word-cloud-canvas"></canvas>
                         <p id="word-cloud-placeholder" class="text-gray-500 dark:text-gray-400">Your topics will appear here.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Past Entries Section -->
        <section id="past-entries-section" class="mt-8 lg:col-span-3 journal-card bg-white dark:bg-gray-800 p-6 rounded-lg hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Past Entries</h2>
            <div id="past-entries-list" class="space-y-4">
                 <!-- Entries will be dynamically inserted here -->
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI ELEMENT REFERENCES ---
        const journalEntry = document.getElementById('journal-entry');
        const saveEntryBtn = document.getElementById('save-entry-btn');
        const buttonText = document.getElementById('button-text');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const dashboardPlaceholder = document.getElementById('dashboard-placeholder');
        const sentimentChartCanvas = document.getElementById('sentiment-chart');
        const pastEntriesSection = document.getElementById('past-entries-section');
        const pastEntriesList = document.getElementById('past-entries-list');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const moodSelector = document.getElementById('mood-selector');
        const promptGeneratorBtn = document.getElementById('prompt-generator-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const streakCountEl = document.getElementById('streak-count');
        const wordCloudCanvas = document.getElementById('word-cloud-canvas');
        const wordCloudPlaceholder = document.getElementById('word-cloud-placeholder');
        const recommendationBox = document.getElementById('recommendation-box');
        const recommendationText = document.getElementById('recommendation-text');

        // --- FIREBASE CONFIG ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, userId;
        let chartInstance = null;
        let journalDataCache = [];
        let selectedMood = null;
        let currentDate = new Date();
        
        // --- DATA & CONFIGS ---
        const prompts = ["What was the best part of my day?", "What's one thing I'm grateful for today?", "A challenge I faced today was...", "What is something I learned about myself today?", "If I could do one thing differently today, what would it be?", "What am I looking forward to tomorrow?", "Describe a moment today that made me smile.", "What's been on my mind lately?"];
        const recommendations = {
            positive: ["Awesome! What's one small thing you can do to share this positivity?", "Great to hear! Try to savor this feeling. Maybe jot down one more detail about what made it great.", "Keep the momentum going! What are you looking forward to most tomorrow?"],
            negative: ["It's okay to have tough days. Consider a short walk to clear your head.", "Sorry to hear that. Maybe listening to some calming music could help.", "Remember to be kind to yourself. Is there a simple, comforting activity you could do?"],
            neutral: ["A neutral day is a chance to reflect. What's one thing you can do to make tomorrow more positive?", "Sometimes a quiet day is just what's needed. What are your intentions for the rest of the day?", "A good time for planning. What's one small goal you can set for yourself?"]
        };

        // --- FIREBASE INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase:", e); displayError("Could not connect to database."); }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { userId = user.uid; initJournal(userId); } 
            else { await signInAnonymously(auth).catch(err => { console.error("Anonymous sign-in failed:", err); displayError("Could not authenticate."); }); }
        });

        // --- JOURNAL INITIALIZATION ---
        function initJournal(uid) {
            const journalCollectionPath = `/artifacts/${appId}/users/${uid}/journal`;
            const q = query(collection(db, journalCollectionPath), orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                journalDataCache = entries;
                if (entries.length > 0) {
                    dashboardPlaceholder.classList.add('hidden');
                    sentimentChartCanvas.classList.remove('hidden');
                    pastEntriesSection.classList.remove('hidden');
                    renderChart(entries);
                    renderEntries(entries);
                    updateStreak(entries);
                    renderWordCloud(entries);
                } else {
                    dashboardPlaceholder.classList.remove('hidden');
                    sentimentChartCanvas.classList.add('hidden');
                    pastEntriesSection.classList.add('hidden');
                    updateStreak([]);
                    renderWordCloud([]);
                }
                renderCalendar(currentDate.getFullYear(), currentDate.getMonth(), entries);
            }, (error) => { console.error("Error fetching journal entries:", error); displayError("Failed to load your journal entries."); });
        }
        
        // --- EVENT LISTENERS ---
        saveEntryBtn.addEventListener('click', handleSaveEntry);
        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcons();
            if (journalDataCache.length > 0) { renderChart(journalDataCache); renderWordCloud(journalDataCache); }
        });
        moodSelector.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; moodSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); selectedMood = button.dataset.mood; });
        promptGeneratorBtn.addEventListener('click', () => { journalEntry.value = prompts[Math.floor(Math.random() * prompts.length)]; journalEntry.focus(); });
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth(), journalDataCache); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth(), journalDataCache); });
        
        function updateThemeIcons() { if (document.documentElement.classList.contains('dark')) { themeToggleDarkIcon.classList.remove('hidden'); themeToggleLightIcon.classList.add('hidden'); } else { themeToggleDarkIcon.classList.add('hidden'); themeToggleLightIcon.classList.remove('hidden'); } }
        
        updateThemeIcons(); // --- INITIAL SETUP ON LOAD ---

        // --- MAIN FUNCTIONS ---
        async function handleSaveEntry() {
            const text = journalEntry.value.trim();
            if (!text) { displayError("Please write something in your journal first."); return; }
            if (!selectedMood) { displayError("Please select your mood before saving."); return; }
            if (!userId) { displayError("Authentication issue. Cannot save entry."); return; }

            setLoading(true);
            try {
                const analysis = await analyzeTextWithGemini(text);
                const journalData = { text, preMood: selectedMood, sentimentScore: analysis.sentimentScore, topics: analysis.topics, timestamp: serverTimestamp() };
                await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/journal`), journalData);
                
                updateRecommendations(analysis.sentimentScore);
                journalEntry.value = "";
                moodSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                selectedMood = null;
            } catch (error) { console.error("Error saving entry:", error); displayError("Failed to analyze or save your entry.");
            } finally { setLoading(false); }
        }

        async function analyzeTextWithGemini(text) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;
            const systemPrompt = `Analyze the journal entry for sentiment (score -1.0 to 1.0) and up to 3 key topics. Respond with VALID JSON: {"sentimentScore": <score>, "topics": ["topic1", "topic2"]}. No other text.`;
            const payload = { contents: [{ parts: [{ text: `Entry: "${text}"` }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } };
            
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) { return JSON.parse((await response.json()).candidates[0].content.parts[0].text); }
                } catch (error) { console.error(`Attempt ${i+1} failed:`, error); if (i < 2) await new Promise(res => setTimeout(res, 1000 * (i + 1))); else throw error; }
            }
            throw new Error(`API request failed.`);
        }

        // --- UI RENDERING & UPDATES ---
        function updateStreak(entries) {
            if (entries.length === 0) { streakCountEl.textContent = 0; return; }
            
            const uniqueDays = [...new Set(entries.map(e => new Date(e.timestamp.seconds * 1000).toDateString()))];
            let currentStreak = 0;
            if (uniqueDays.length > 0) {
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);
                
                if (uniqueDays.includes(today.toDateString()) || uniqueDays.includes(yesterday.toDateString())) {
                    currentStreak = 1;
                    let lastDate = new Date(uniqueDays[uniqueDays.length - 1]);
                    for (let i = uniqueDays.length - 2; i >= 0; i--) {
                        const currentDate = new Date(uniqueDays[i]);
                        const diff = (lastDate.getTime() - currentDate.getTime()) / (1000 * 3600 * 24);
                        if (diff === 1) { currentStreak++; lastDate = currentDate; } 
                        else { break; }
                    }
                }
            }
             streakCountEl.textContent = currentStreak;
        }
        
        function renderWordCloud(entries) {
            const topicCounts = entries.flatMap(e => e.topics || []).reduce((acc, topic) => {
                acc[topic] = (acc[topic] || 0) + 1;
                return acc;
            }, {});

            const list = Object.entries(topicCounts).sort((a,b) => b[1] - a[1]);

            if (list.length > 0) {
                wordCloudPlaceholder.classList.add('hidden');
                wordCloudCanvas.classList.remove('hidden');
                WordCloud(wordCloudCanvas, { 
                    list: list,
                    gridSize: Math.round(16 * wordCloudCanvas.width / 1024),
                    weightFactor: (size) => Math.pow(size, 2.3) * wordCloudCanvas.width / 1024,
                    color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563',
                    backgroundColor: 'transparent'
                });
            } else {
                 wordCloudPlaceholder.classList.remove('hidden');
                 wordCloudCanvas.classList.add('hidden');
            }
        }
        
        function updateRecommendations(score) {
            let category;
            if (score > 0.2) category = 'positive';
            else if (score < -0.2) category = 'negative';
            else category = 'neutral';

            const recommendation = recommendations[category][Math.floor(Math.random() * recommendations[category].length)];
            recommendationText.textContent = recommendation;
            recommendationBox.classList.remove('hidden');
        }

        function renderCalendar(year, month, entries) {
            calendarGrid.innerHTML = '';
            currentMonthYearEl.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const entriesByDate = entries.reduce((acc, entry) => {
                if (entry.timestamp) {
                    const date = new Date(entry.timestamp.seconds * 1000);
                    if(date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        if (!acc[day]) acc[day] = [];
                        acc[day].push(entry.sentimentScore);
                    }
                }
                return acc;
            }, {});

            for (let i = 0; i < firstDay; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div class="calendar-day empty"></div>`); }
            for (let day = 1; day <= daysInMonth; day++) {
                let dayEl = `<div class="calendar-day bg-gray-200 dark:bg-gray-700"><span>${day}</span></div>`;
                if(entriesByDate[day]) {
                    const avgScore = entriesByDate[day].reduce((a, b) => a + b, 0) / entriesByDate[day].length;
                    let colorClass = 'bg-gray-400 dark:bg-gray-500 text-white';
                    if (avgScore > 0.5) colorClass = 'bg-green-500 text-white'; else if (avgScore > 0.2) colorClass = 'bg-green-300 dark:bg-green-600 text-green-800 dark:text-white';
                    else if (avgScore < -0.5) colorClass = 'bg-red-500 text-white'; else if (avgScore < -0.2) colorClass = 'bg-red-300 dark:bg-red-600 text-red-800 dark:text-white';
                    dayEl = `<div class="calendar-day ${colorClass}" title="Avg. Sentiment: ${avgScore.toFixed(2)}"><span>${day}</span></div>`;
                }
                calendarGrid.insertAdjacentHTML('beforeend', dayEl);
            }
        }

        function renderChart(entries) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? 'rgba(209, 213, 219, 1)' : 'rgba(55, 65, 81, 1)';
            const gridColor = isDarkMode ? 'rgba(75, 85, 99, 0.5)' : 'rgba(209, 213, 219, 0.5)';
            const ctx = sentimentChartCanvas.getContext('2d');
            const data = entries.map(e => e.sentimentScore);
            if (chartInstance) { chartInstance.destroy(); }
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: entries.map(e => e.timestamp ? new Date(e.timestamp.seconds * 1000).toLocaleDateString() : 'Now'), datasets: [{ label: 'Sentiment Trend', data, fill: false, borderColor: 'rgba(59, 130, 246, 1)', tension: 0.1, pointBackgroundColor: data.map(s => s > 0.2 ? 'rgba(75,192,192,1)' : s < -0.2 ? 'rgba(255,99,132,1)' : 'rgba(201,203,207,1)'), pointRadius: 5, pointHoverRadius: 8 }] }, options: { responsive: true, scales: { y: { beginAtZero: false, min: -1, max: 1, title: { display: true, text: 'Sentiment Score', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } }, x: { title: { display: true, text: 'Date', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: textColor } }, tooltip: { callbacks: { label: (c) => { let l = c.dataset.label || ''; if(l)l+=': '; if(c.parsed.y !== null){const s=c.parsed.y;let sentiment="Neutral";if(s>0.2)sentiment="Positive";if(s<-0.2)sentiment="Negative";l+=`${s.toFixed(2)} (${sentiment})`;}return l; } } } } } });
        }
        
        function renderEntries(entries) {
            pastEntriesList.innerHTML = '';
            [...entries].reverse().forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'border-b border-gray-200 dark:border-gray-700 pb-4';
                const date = entry.timestamp ? new Date(entry.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                const sentimentScore = entry.sentimentScore.toFixed(2);
                let sentimentText = "Neutral", sentimentColor = "bg-gray-400 text-white dark:bg-gray-500";
                if(entry.sentimentScore > 0.2) { sentimentText = "Positive"; sentimentColor = "bg-green-500 text-white"; } 
                else if (entry.sentimentScore < -0.2) { sentimentText = "Negative"; sentimentColor = "bg-red-500 text-white"; }
                const topicsHTML = (entry.topics || []).map(topic => `<span class="topic-badge bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">${topic}</span>`).join('');
                const preMoodHTML = entry.preMood ? `<div class="mt-2 sm:mt-0"><span class="font-semibold text-sm">Initial Mood:</span> <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${entry.preMood}</span></div>` : '';
                entryDiv.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">${date}</p><p class="my-2 text-gray-700 dark:text-gray-300">${entry.text}</p><div class="flex items-center justify-between flex-wrap gap-y-2"><div><span class="font-semibold text-sm">AI Sentiment:</span> <span class="topic-badge ${sentimentColor}">${sentimentText} (${sentimentScore})</span></div>${preMoodHTML}<div class="w-full sm:w-auto"><span class="font-semibold text-sm">Key Topics:</span> ${topicsHTML || '<span class="text-sm text-gray-500 italic">None</span>'}</div></div>`;
                pastEntriesList.appendChild(entryDiv);
            });
        }

        function setLoading(isLoading) { if (isLoading) { saveEntryBtn.disabled = true; buttonText.textContent = "Analyzing..."; loader.classList.remove('hidden'); errorMessage.textContent = ""; } else { saveEntryBtn.disabled = false; buttonText.textContent = "Save Entry"; loader.classList.add('hidden'); } }
        function displayError(message) { errorMessage.textContent = message; setTimeout(() => { errorMessage.textContent = ""; }, 5000); }
    </script>
</body>
</html>

